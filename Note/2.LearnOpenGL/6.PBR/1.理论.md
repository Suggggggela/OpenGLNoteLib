
## 1.PBR
PBR的全称为Physically based Rendering，基于物理的渲染
它是一系列渲染技术的统称，就像它的名字一样，这些技术是基于物理世界的理论来渲染的方法
这些技术旨在基于物理上可信的方式模拟光线的传播

相比于我们之前接触的光照计算方式（统称为传统光照模型），PBR看起来更好，制作起来统一，对于不同的光照条件也材质表现也趋于正确

注意，这里使用的还是based这个词，也就是说这些技术是基于物理的而非完全物理
要使得这些光照计算技术based物理，那么需要满足以下条件：
1. based on the Microfacet model，**基于微表面理论**
2. be Energy consercation，**必须能量守恒**
3. use a Physically based BRDF， **使用基于物理的BRDF模型**

这三个概念我们会在下边的内容逐个讲解

## 2.The Microfacet model - 微表面理论
所有的PBR技术都是基于微表面理论的
该理论认为：
- 在微观尺度下，任何表面都可以被称为**微表面Microfacet**的微小镜面(tiny little perfectly reflective mirror)来描述
- 根据表面的粗糙情况不同，这些微小镜面的排列有很大差异


![[assets/1.理论_image_1.png|515x97]]
- 表面越粗糙，每个微表面沿表面的排列就越混乱
- 对于镜面反射
    - 粗糙表面射入的光线更有可能沿着完全不同的方向散射(scatter)，表现出的效果就是范围更大的高光
    - 光滑表面则更有可能沿着大致相同的方向反射(reflect)，表现出的效果就是范围小但是更亮更清晰的高光
![[assets/1.理论_image_2.png|529x99]]

在微观尺度下没有表面是完全光滑的，但是由于微表面太小了，无法通过逐像素的尺度来表达
我们可以使用**粗糙度(roughness)** 对表面的粗糙程度进行统计学近似
基于粗糙度，我们计算出表面与**h向量(half Vector半程向量)** 大致对齐的Microfacet ratio（微表面比率）
微表面和半程向量的对齐度越高，镜面反射就越清晰、强烈（粗糙度越小）
下边是Roughness在0~1之间，从统计学角度对微表面对齐情况进行的近似分析：
![[assets/1.理论_image_3.png|654x137]]


## 3.Energy consercation - 能量守恒
微表面近似法采用了一种**能量守恒的形式：出射光一定不会超过入射光的能力（不包括自发光）**
我们可以通过观察上边微表面理论最后的高光近似分析图来理解：
- 粗糙度高，镜面反射面积大，但是亮度低
- 粗糙度低，镜面反射面积小，但是亮度很高

也就是说不管表面粗糙度是多少，出射光的能量都是近似的，而且肯定不能超过入射光的能量

为了遵守能量守恒，我们需要明确的区分漫反射(diffuse)和高光/镜面反射(specular)
光线照射到表面的瞬间，会分为refraction折射和reflection反射两部分：
- 折射部分 = 光线进入表面并被吸收的剩余部分，这部分就是diffuse
- 反射部分 = 直接被表面反射，没进入表面的光线，这部分就是specular

这里有些细微的差别，折射光不会在接触表面后被立即吸收。在物理学中，我们知道光可以被模拟为一束能量光，它不断地向前步进直到失去所有能量
就像下图这样，每种Material都是由微小颗粒组成，它们可以和光线发生碰撞，每次碰撞后它们都可以吸收部分/全部光的能量
![[assets/1.理论_image_4.png|447x294]]
一般来说，光线的能量都不会被完全吸收，光线会继续向随机方向散射，继续与其他粒子碰撞，直到能量完全耗尽/离开表面
如果从表面重新射出，这部分钢线会形成表面的observed color(观察颜色，就是看起来的颜色)，也就是 diffuse color

**次表面散射**
然而到此为止我们做的是一个简化的假设，既：所有折射光线都会在极小的影响范围内被吸收和散射
这里我们没有考虑影响范围外（远处表面）射出的散射光线的对当前的影响
有些技术是考虑到这一点的，我们称为次表面散射（subsurface scattering），它可以显著的改善相关特性比较明显的材质，比如：皮肤、大理石、蜡等

**金属表面**
金属表面的反射和折射的微妙之处在于：与非金属（也称为电介质）相比，金属表面遵循相同的反射和折射原理，但是所有折射光都会被直接吸收而不会散射出去
简单的说就是，金属表面只有镜面反射（反射光），没有漫反射（都被吸收了，没有剩余部分了，所以就没有了）
由于金属和非金属这部分明显的区别，我们在PBR Pipeline中对他们的处理方式也有所不同，后续我们会深入探讨

**反射折射互斥**
反射光和折射光的区别让我们看到了另一种能量守恒的现象：它们是相互排斥的。无论是什么光，被反射的光将不会再被Material本身吸收
因此，折射光作为被表面内部吸收后剩下的能量，正好就是我们计算完反射之后剩下的能量

我们按照能量守恒，先计算反射(镜面折射)部分，它是一个相对于入射光能量的百分比量。按照上边的推论，用1-反射光比率就是折射光的比率
```cpp
float kS = calculateSpecularComponent(...); // reflection/specular fraction 
float kD = 1.0 - kS; // refraction/diffuse fraction
```

到此为止，我们可以同时知道入射光的反射和折射量，并且它们符合能量守恒


## 4.The reflectance Equation - 反射方程
接下来我们来看看渲染方程
PBR遵循一种渲染方程，即反射方程，要想正确的理解PBR，需要先理解这个方程：
![[assets/1.理论_image_5.png|492x82]]
//关于这个方程的历史这里我们就不补充了，这里我们重在理解
这个方程一眼看过去还是挺吓人的，所以我们先要做一些“准备”


### 辐射度量学
要想理解这个方程的意义，我们先要涉及一些**辐射度量学**概念

//为了一会儿不被搞得头晕脑花，我们这里先把浅墨整理的辐射量参数列个表格，作为后续对照参考
//后续关于这些辐射量概念，我们统一使用英文名称（英文反而更好理解）
![[assets/1.理论_image_6.png|574x343]]
//如果你还想知道更多，或者在这部分没有很明白的理解，推荐你**查阅GAMES101-Lecture14~15部分**

**Radiometry - 辐射度量学**
            辐射度量学时一种用来度量电磁辐射的手段，电磁辐射包括可见光
            有很多种radiometric quantities（辐射度量）可以用于测量曲面或某个方向上的光
            这里我们只讨论和反射方程有关的，它被称为Radiance（辐照率）

**Radiance - 辐照率**
            Radiance在这里使用大写**L**表示
            它被用来量化来自单一方向上的光线强度
            由于Radiance是有许多物理变量的集合，我们耐下心往下看看
        
**Radiant flux - 辐射通量**
            Radiant flux **Φ(Phi,大写)** 表示一个光源单位时间传输/发射的能量，以Watt瓦特为单位，
            //这里的单位时间是因为我们在做辐射度量学时，不考虑时间累积的能量，因为累积下来一定会过曝（类比相机）
            光是多个不同波长的能量总和，每个波段的波长和一种特定的颜色相对应
            因此，光源的发射能量可以看作是所有波段波长的一个函数
            
对于不同的波段，390nm~700nm范围的光被我们称为可见光
        下图是日光中不同波段光的能量示意图：
![[assets/1.理论_image_7.png|395x261]]
            
Radiant测量的是这个不同波长函数的总面积
并且我们通常会将Radiant简化为RGB（直接将不同波长的计量作为参数的输入不太可行），这样简化会带来一些信息损失，但是对于视觉效果的影响基本可以忽略

**Solid angle - 立体角**
            立体角**ω(omega)**描述的是投影到单位球面上的一个截面大小/面积，你可以把它可视化为一个带体积的方向
            ![[assets/1.理论_image_8.png|309x228]]
                想象一下：当你位于单位球的中间作为一个观察者，朝着这个截面的方向看去，看到的轮廓大小就是立体角

**Radiant intensity - 辐射强度**
            Radiant intensity表示的是在一个单位球上，光源向某个单位面积A在每个立体角投送的Radiant flux
            比如说，如果一个全向光源向所有方向均匀的辐射能量，那么通过Radiant intensity就可以计算出它在特定区域（立体角）内的能量
            ![[assets/1.理论_image_9.png|320x309]]
            描述radiant intensity的方程如下：
            ![[assets/1.理论_image_10.png|83x53]]
            其中I就是立体角上的Radiant intensity

在了解了上边这些概念之后，我们就可以讨论Radiance的方程了：
![[assets/1.理论_image_11.png|183x62]]
![[assets/1.理论_image_12.png|359x311]]
            这个方程表示：一个辐照强度Φ的光源在单位面积A，单位立体角ω上辐射出的总能量L(Radiance)
            
Radiance表示一个ω方向区域平面上光线总量，它受入射(Incident)光与平面法线之间的夹角cosθ的影响：当直接照射到表面（夹角越大）时光线越弱，当垂直照射到表面（法向，夹角越小）时光线越强
这一点和我们之前计算经典光照模型时是一致的
```cpp
float cosTheta = dot(lightDir, N);
```

Radiance之所以这么被我们关注，是因为它包含了大部分我们感兴趣的物理量
        如果我们把立体角和面积A看作是无穷小的，那么我们就可以通过Radiance表示单束光线穿过空间中一个点的radiant flux
        根据这一关系，这个点可以作为**单个fragment**上单束光线的Radiance
        实际情况中，我们将立体角转变成为ω方向向量，把面积A转变为点p，这样我们就能够直接在shader中使用Radiance计算一束光线在每个fragment上的贡献值了

**Irradiance - 辐照度**
            实际上，当我们谈论Radiance时，我们通常更关心所有射入点p光线
            这部分是所有Radiance的总和，我们称之为**Irradiance**
            
### 重回反射方程
到此为止，我们已经对需要的辐射度量学概念过了一遍，接下来再返回来看反射方程：
![[assets/1.理论_image_13.png|420x70]]
![[assets/1.理论_image_14.png|468x276]]
//注：上图从GAMES101截取，ωr就是我们这里的ωo
我们不妨使用上边学到的辐射度量学概念对这个方程进行一些解释：
- **Li(p,ωi)** 代表被当做无限小的立体角ωi方向上在点p上的Radiance
- **n·ωi** ：光线入射到表面的角的余弦值cosθ用来scale能量
- **ωo**在这里表示光线反射/观察方向（上图中为ωr，o=obs，r=reflect，实际上是一个意思）
- 反射方程**Lo(p,ωo)**计算了**所有**点p在ωo方向被**反射出**的**Radiance**。换句话说，Lo(p,ωo)表示了光在点p从ωo方向**反射出的Irradiance**


基于反射方程中L代表某个无限小立体角方向的Radiance的总和（Irradiance），我们需要考虑的也不再是单一立体角方向，而是点p为球心的**半球领域Ω**内所有方向的入射光
//使用半球是认为背面过来的光表面不受影响
这个半球可以描述为以表面法线n为轴环绕的半个球体：
![[assets/1.理论_image_15.png|349x259]]
为了计算一个面内的值或者体积的值，我们会使用数学中的**integral-积分**
**∫**就是积分符号，在反射方程中的意思就是积分半球Ω上的所有ω入射方向的dωi
积分运算的结果就是函数的面积，可以通过分析或者数值计算出（解析解，数值解）
由于渲染方程和反射方程都没有解析解，我们需要通过对积分离散求解
那么可以将问题转化为：在半球Ω中按一定的步长将反射方程离散求解，然后按照步长将结果平均
这种方法称为Rieman sum - 黎曼求和，伪代码如下：
```cpp
int steps = 100; float sum = 0.0f; 
vec3 P = ...; 
vec3 Wo = ...; 
vec3 N = ...; 
float dW = 1.0f / steps; 
for(int i = 0; i < steps; ++i) 
{ 
    vec3 Wi = getNextIncomingLightDir(i); 
    sum += Fr(P, Wi, Wo) * L(P, Wi) * dot(N, Wi) * dW; 
}
```
- 以上的dw用来对所有的离散结果进行scale，最后sum的结果就是积分函数的总面积/体积
- 在数学上dw是用于计算积分的连续符号，和代码中的dw并没有什么关联
    - 但是这里我们可以将代码中的dw和反射方程中的dw视为一致，但是实际上代码中的dw是黎曼和的离散步长
    - 所以这里的sum并不是反射方程的准确解而是一个近似解
    - 我们可以通过增加step来提高黎曼和的Accuracy(准确度)


    到此为止，我们只剩下fr(p,ωi,ωo)这一项没有说了，这项就是BRDF
    我们不妨总结一下反射方程的左右边推断一下：
    - 左边 = 在点p反射的Irradiance
    - 右边：
        - Li(p,ωi)表示入射的Radiance
        - Li(p,ωi)n·ωi增加了微小立体角方向时平面法线和入射光夹角对Radiance的Scale
        - Li(p,ωi)dωi表示入射的Irradiance

那么我们可以推断出：BRDF是描述光线从入射光方向到表面后如何反射出去的
换句话说：**BRDF描述光线是如何和表面交互的**

## 5.BRDF 
BRDF全程为bidirectional reflective distribution function，即双向反射分布函数
BRDF接受的输入为：
- ωi  入射光方向
- ωo 出射光方向
- n    表面法线
- α    微表面粗糙度

通过这个function，我们可以计算出入射光打到材质表面后反射光的贡献程度
我们可以这么理解，假设一个表面完全光滑（入射的光会全部反射出去）
- 对于入射光ωi而言，BRDF会返回0
- 对于出射光ωo而言，BRDF会返回1


### Microfacet BRDF
微表面BRDF是一系列BRDF的通常
现在我们说到的PBR，使用的基本上都是基于微表面理论的BRDF

基于微表面理论下，BRDF描述的是材质的反射和折射特性
多说一句，从技术角度上看，Blinn-Phong的模型也可以被视为一种BRDF，它的输入参数和ωi和ωo相同，但是它没有符合能量守恒，所以不能说是Phyphic-based

目前存在多种基于物理的BRDF模型，其中最出名的是Cook-Torrance BRDF
Cook-Torrance BRDF同时包含漫反射和高光部分：
![[assets/1.理论_image_16.png]]
- kd为折射比例
- ks为反射比例


**漫反射BRDF**
k<sub>d</sub>flambert表示漫反射，其中flambert是一个常数因子
f<sub>lambert</sub> =  c/π      c表示微表面颜色，除以π用于漫反射光的归一化（后续IBL部分会细说）
//这里的lambert漫反射常数会让你想到之前的传统光照模型，实际上cosθ在BRDF外部的n·ωi
对于上述的漫反射Part，除了lambert模型外还存在着其他模型，但是Epic使用的实时部分就是这个，所以也够用了

**高光BRDF**
高光部分的BRDF如下：
![[assets/1.理论_image_17.png]]

- D = Normal Distribution Function，法线分布函数，表示微表面法线和半程向量的一致性，起主要作用
- F = Fresnel Equation， 菲涅尔方程，表示不同角度下观察表面反射的比率
- G = Geometry Function， 几何函数，修正微表面的自遮挡情况

以上的每项都有不止一种形式，有些性能好，有些更真实，这里我们将采样UE4中的函数：
- D项：Trowbridge-Reitz GGX
- F项：Fresnel-Schlick approximation 
- G项：Smith's Schlick-GGX 

其他更多的可以自行查阅，这里贴一个 https://graphicrants.blogspot.com/2013/08/specular-brdf-reference.html

### Normal distribution function-法线分布函数
我们先看下图，想一下，什么情况下微表面入射的光能够反射到出射的方向：微表面法线和半程向量h对齐时
![[assets/1.理论_image_18.png|325x187]]
法线分布项D，有些人也说NDF，近似的表示了法线和半程向量对齐的微表面比率，换句话说，法线分布描述了表面的粗糙程度
比如现在有35%的微表面法线和半程向量h对齐，那么NDF项就会返回0.35

给定一些粗糙度参数，就可以通过统计学估算微表面的总体排列情况（相对于h）
我们使用的Trowbridge-Reitz GGX的NDF如下：
![[assets/1.理论_image_19.png|429x54]]
- α表示粗糙度
- h表示半程向量

当表面粗糙度很低时，微表面的法线与半程向量对齐会集中在很小的半径范围，就是小而亮的高光
当表面粗糙度很高时，微表面的法线与半程向量对齐会分布到一个很大的半径范围，就是范围大但是灰暗的高光
![[assets/1.理论_image_20.png|537x113]]

Trowbridge-Reitz GGX的法线分布项的代码类似下边这样：
```cpp
float DistributionGGX(vec3 N, vec3 H, float a)
{
    float a2     = a*a;
    float NdotH  = max(dot(N, H), 0.0);
    float NdotH2 = NdotH*NdotH;
	
    float nom    = a2;
    float denom  = (NdotH2 * (a2 - 1.0) + 1.0);
    denom        = PI * denom * denom;
	
    return nom / denom;
}

```

### Geometry function-几何函数
几何项又叫做shadowing-masking项
微表面之间可能会发生自遮挡情况，不论是观察还是光源打过来，在方向接近平行平面时可能性更高
我们可以直接看图理解：
![[assets/1.理论_image_21.png|459x145]]

几何项就是为了修正上边这样的情况
几何项描述了微表面之间相互遮挡的比率，它的输入α粗糙度，越粗糙的表面它的微表面之间自遮挡的比率就越高

这里我们使用的是GGX与Schlick-Beckmann近似的结合体，因此成为Schlick-GGX：
![[assets/1.理论_image_22.png|362x47]]
这里的k是粗糙度α的remapping，具体的映射方法根据针对的是直接光照还是IBL不同：
![[assets/1.理论_image_23.png|171x133]]

上边我们说到，几何自遮挡对于观察和光入射都是会发生的，所以需要将Geometry Obstruction(观察的几何遮蔽)和Geometry Shadowing(光入射的几何阴影)都考虑进去
这里使用Smith's Method把上边两者都纳入其中：
![[assets/1.理论_image_24.png|436x32]]

Schlick-GGX作为G项的效果可以参考下边这样：
![[assets/1.理论_image_25.png|666x140]]

代码如下：
```cpp
float GeometrySchlickGGX(float NdotV, float k)
{
    float nom   = NdotV;
    float denom = NdotV * (1.0 - k) + k;

    return nom / denom;
}

float GeometrySmith(vec3 N, vec3 V, vec3 L, float k)
{
    float NdotV = max(dot(N, V), 0.0);
    float NdotL = max(dot(N, L), 0.0);
    float ggx1 = GeometrySchlickGGX(NdotV, k);
    float ggx2 = GeometrySchlickGGX(NdotL, k);

    return ggx1 * ggx2;
}
```

### Fresnel equation-菲涅尔方程
菲涅尔方程描述了反射光与折射光的比例关系，它与观察表面的角度有关，随着观察角度而变化
![[assets/1.理论_image_26.png]]
可以看到当实现垂直到表面时几乎看不到书，当以靠近表面的角度观察时，桌子上出现了书的反射
如果你身边有木桌子，你也可以自行验证一下

当我们观察表面时，任何材质都有一个Base Reflectivity（基础反射率）。当以某个角度（平行表面）观察时，所有反射都会比基础反射率明显，理论上所有表面在平行观察时会完全反射光线
上述现象成为Fresnel效应，并且由Fresnel方程描述

菲涅尔是一个相当复杂的方程（这里我们不细讲了，GAMES101中有提到过，在第十七讲，甚至涉及光的波动性）
我们使用的是Fresnel-Schlick近似：
![[assets/1.理论_image_27.png]]
- F<sub>0</sub>表示表面的反射率，它是利用Indices of Refraction（折射指数）IOR计算得出的
![[assets/1.理论_image_28.png|267x256]]


菲涅尔效应还有一点是对于dielectric电介质（非金属）和 conductor导体（金属）表面有区别
Schlick近似只定义了非金属，对于金属这个近似是错误的，这样我们就需要使用另外一种方式计算金属的菲涅尔项
区分金属和非金属进行计算很不方便，我们可以预计算出表面法线方向入射的结果（F0），然后根据Fresnel-Schlick近似法，根据view angle进行插值估算。这样就能对金属和非金属使用同一公式了
前边我们说过任何材质都有一个基础反射率，表面法线方向入射的结果就是这个基础反射率
我们可以在大型数据库中查找不同材质的基础反射率，比如这里： https://refractiveindex.info/
本篇我们列举一些常见材质：
![[assets/1.理论_image_29.png]]
- 电介质（非金属）的基础反射率不大于0.17
- 导体（金属）的基础反射率大多介于0.5~1.0，并且带有颜色

因为金属和非金属的材质特点，引出了**metallic workflow - 金属度工作流**（另一种工作流是specular workflow）。金属度工作流中需要额外一个Metalness金属度参数
理论上讲金属度代表材质是否是金属，应该是bool，但是大部分RenderPipeline都允许在0~1之间调整金属度。这主要是因为material texure的精度不足导致的。当金属表面存在微小粉尘/沙粒状颗粒/划痕时，二元金属度难以准确的呈现其视觉效果

通过预计算的F0，我们可以对金属和非金属采用相同的Fresnel-Schlick近似。
不过对于金属表面，我们必须调整基础反射率，通常用以下方式实现：
```cpp
vec3 F0 = vec3(0.04); 
F0 = mix(F0, surfaceColor.rgb, metalness);
```
我们已经为大多数非金属定义了一个近似的基础反射率F0 = 0.04，取得是最常见非金属的平均值
虽然这个是更近似的值了，但是这作为一个常量在不需要其他参数得到相对物理可信的结果，对于大多数非金属已经足够好了
对于金属表面
- 我们根据金属度取非金属的基础反射率或F0作为表面颜色都可
- 金属表面会吸收所有折射光，也就是说没有折射后剩余的光，也就没有漫反射。我们可以把surface color texture作为它的基础反射率

Fresnel-Schlick近似的代码类似下边这样：
```cpp
vec3 fresnelSchlick(float cosTheta, vec3 F0)
{
    return F0 + (1.0 - F0) * pow(1.0 - cosTheta, 5.0);
}

//θ为n和v的夹角 即cosθ为dot(n,v)
```

### Cook-Torrance reflectance equation
到此为止，我们将反射方程的所有项都说到了
接下来看一下Cook-Torrance的反射方程：
![[assets/1.理论_image_30.png|475x59]]
这个方程在数学上并不完全正确
上述Fresnel项中代表表面反射光的比率，也就是说F项隐含了Ks
所以最终的反射方程应该是：
![[assets/1.理论_image_31.png|509x66]]

## PBR Material
在实际的PBR流程中，所有参数都可以使用贴图来表示，类似下边这样：
![[assets/1.理论_image_32.png|538x296]]
- Albedo
    - 反照率，指定表面颜色或者基础反射率
    - Albedo类似漫反射贴图，但是不等于漫反射贴图，Albedo贴图中不应该包含光照后的信息（比如：阴影、AO等等）
- Normal
    - 法线贴图和之前使用的一样
- Metallic
    - 金属度，指定是否为金属
    - 可以是二元值，也可以是线性的0~1的灰度，根据不用管线决定
- Roughness
    - 粗糙度
    - 某些管线会使用Smoothness光滑度贴图，其实就是1-Roughness
- AO
    - 环境光遮蔽
    - 为表面和潜在周围几何体指定额外的阴影因子
    - 特别是光线难以穿透的地方，可以使用AO作为补充
    - 一般都是通过DCC软件烘焙的


## More
 Todo：
 - [x] 辐射度量学中各个概念的总结
 - [ ] BRDF变体
 - [ ] 渲染方程，反射方程的更具体内容

### 辐射度量学概念总结
#### Radiant Energy，Radiant Flux
 - Radiant Energy：**辐射的能量**， 单位：J焦耳
 - Radiant Flux(Power)：**单位时间辐射的能量**， 单位：W瓦特， lumen流明
     - 能量/时间 = 功率，也就是说flux其实是功率
     - 为什么要用功率？ ->我们不希望考虑时间对于能量的累积，因为这一定会过曝，我们需要的是固定的能量
     - 对于W这个单位，我们经常在灯泡上见到，实际上就是指单位时间能通过的能量

#### 如何通过辐射度量学定义光线传播
我们可以将光线传播分为三类：
- 光源往外辐射 - Radiance Intensity
- 表面接收能量 - Irradiance
-  光线传播的过程 - Radiance
![[assets/1.理论_image_33.png|448x232]]
##### Radiance Intensity
定义：power per unit solid angle，单位立体角内通过的能量（Radiant flux）
I = flux / ω =  Φ / 4π
##### Solid Angle
数学上的二维Angle：弧度
![[assets/1.理论_image_34.png|190x185]]
- θ = l / r 弧长/半径
- 圆的整个弧度 = 周长/半径 = 2π radians


Solid Angle是作为三维上的延伸
![[assets/1.理论_image_35.png|180x183]]
定义：方向投影到球面上的面积A / 半径平方
- Ω = A / r<sup>2</sup>
- 整个球面的立体角 = 面积/半径平方 = 4π steradians
- 单位立体角：单位面积/半径平方 
    - dA = (rdθ)(rsinθdφ) = r<sup>2</sup>sinθdθdφ
    - dω = dA/r<sup>2</sup> = sinθdθdφ


##### Irradiance
定义：power per unit Area，单位面积内通过的Radiant flux
E(x) = dΦ(x) / dA  单位 lumen/m<sup>2</sup> = lux

##### Radiance
Radiance用于描述光线传播过程
定义：power per unit angle，per unit Area，单位面积在单位立体角方向通过的Radiant flux 
![[assets/1.理论_image_36.png|427x200]]

#### Radiance和其他概念的联系
- Radiance = 
    - Irradiance per solid angle 单位立体角通过的Irradiance
    - Radiant Intensity per unit Area 单位面积通过的Radiant Intensity




#### Incident Radince
定义：Irradiance per unit solid angle arriving the surface，单位立体角到达表面的Irradiance
    想对于Irradiance ，Radiance拥有了方向性
#### Exiting Radiance
定义：Radiant Intensity per unit Area leaving the surface，单位面积离开的表面的Radiant Intensity